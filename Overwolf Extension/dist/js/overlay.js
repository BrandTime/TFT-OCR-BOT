/******/ (() => { // webpackBootstrap
/******/ 	"use strict";
/******/ 	var __webpack_modules__ = ({

/***/ "./src/overlay/overlay.ts":
/*!********************************!*\
  !*** ./src/overlay/overlay.ts ***!
  \********************************/
/***/ ((__unused_webpack_module, exports) => {


Object.defineProperty(exports, "__esModule", ({ value: true }));
exports.overlay = exports.Overlay = void 0;
class Overlay {
    constructor() {
        this.players = [];
        this.selfName = "";
        this.path = "E:\\Development\\Python\\TFT-OCR-BOT-main\\live_data\\";
        this.g_interestedInFeatures = [
            'counters',
            'match_info',
            'me',
            'roster',
            'store',
            'board',
            'bench',
            'carousel',
            'live_client_data'
        ];
        this.setup();
    }
    setup() {
        overwolf.games.onGameInfoUpdated.addListener((res) => {
            console.debug("onGameInfoUpdated", res);
            if (res.gameChanged) {
                this.players = [];
            }
            if (Overlay.gameLaunched(res)) {
                this.registerEvents();
                setTimeout(() => this.setFeatures(), 1000);
            }
        });
        overwolf.games.getRunningGameInfo((res) => {
            console.debug("getRunningGameInfo", res);
            if (Overlay.gameRunning(res)) {
                this.registerEvents();
                setTimeout(() => this.setFeatures(), 1000);
            }
            else {
                this.players = [];
            }
        });
        overwolf.games.launchers.events.getInfo(10902, info => {
            if (info.success) {
                this.selfName = info.res.summoner_info.display_name;
            }
        });
        this.setPosition();
    }
    setFeatures() {
        overwolf.games.events.setRequiredFeatures(this.g_interestedInFeatures, (info) => {
            if (!info.success) {
                window.setTimeout(() => this.setFeatures(), 2000);
                return;
            }
            console.info("Set required features:");
            console.info(JSON.stringify(info));
        });
    }
    handleEvent(info) {
        const feature = info.feature;
        const key = info.key;
        if (feature === "roster" && key === "player_status") {
            this.handleRoster(info.value);
        }
        else if (feature === "match_info" && key === "opponent") {
            this.setLastOpponent(info.value);
        }
    }
    handleRoster(jsonStr) {
        const roster = JSON.parse(jsonStr);
        const players = [];
        for (const name in roster) {
            const playerData = roster[name];
            playerData.name = name;
            players.push(playerData);
        }
        players.sort((a, b) => a.index - b.index);
        if (players.length) {
            if (this.players.length && players.length) {
                this.updateRoster(players);
            }
            else {
                this.setupRoster(players);
            }
        }
    }
    async setupRoster(players) {
        if (!this.selfName) {
            this.selfName = await this.getSummonerName();
        }
        this.reset();
        players.forEach((data, i) => {
            if (data.name !== this.selfName) {
                const box = document.querySelector(`#box-${i}`);
                const player = { name: data.name, box: box };
                player.box.style.borderColor = "green";
                this.players.push(player);
            }
        });
        this.setPosition();
    }
    updateRoster(players) {
        const me = players.find(player => player.name === this.selfName);
        if (me && me.health <= 0) {
            this.reset();
            return;
        }
        this.players.forEach(player => {
            players.forEach(data => {
                if (player.name === data.name && data.health <= 0) {
                    this.removePlayer(data.name.trim());
                }
            });
        });
    }
    removePlayer(name) {
        const player = this.players.find(player => player.name.trim() === name.trim());
        const index = this.players.indexOf(player);
        if (index !== -1) {
            this.players.splice(index, 1);
            player.box.style.borderColor = "transparent";
            this.clear();
        }
    }
    setLastOpponent(jsonStr) {
        if (this.players.length === 0) {
            return;
        }
        const opponentName = JSON.parse(jsonStr).name.trim();
        const opponent = this.players.find(player => player.name === opponentName);
        const index = this.players.indexOf(opponent);
        if (index !== -1) {
            this.players.splice(index, 1);
            this.players.push(opponent);
            opponent.box.style.borderColor = "red";
        }
        this.updateOverlay();
    }
    updateOverlay() {
        const potentialCount = this.players.length > 3 ? 3 : this.players.length - 1;
        this.players.slice(0, potentialCount).forEach(player => {
            player.box.style.borderColor = "green";
        });
    }
    clear() {
        this.players.forEach(player => {
            player.box.style.borderColor = "green";
        });
    }
    reset() {
        document.querySelectorAll(`.box`).forEach((box) => box.style.borderColor = "transparent");
        this.players = [];
    }
    setDebug() {
        const debugEl = document.querySelector(".debug");
        debugEl.innerHTML = `${this.selfName}<br>${this.players.map(player => player.name).join("<br>")}`;
        setTimeout(() => this.setDebug(), 1000);
    }
    registerEvents() {
        console.info("register events");
        overwolf.games.events.onInfoUpdates.addListener((event) => {
            this.handleEvent(event.info[0]);
        });
        overwolf.games.events.onInfoUpdates2.addListener((event) => {
            switch (event.feature) {
                case "store":
                    if (event.info)
                        overwolf.io.writeFileContents(this.path + "store.txt", JSON.stringify(event.info), "UTF8", false, event => { });
                    break;
                case "board":
                    if (event.info)
                        overwolf.io.writeFileContents(this.path + "board.txt", JSON.stringify(event.info), "UTF8", false, event => { });
                    break;
                case "bench":
                    if (event.info)
                        overwolf.io.writeFileContents(this.path + "bench.txt", JSON.stringify(event.info), "UTF8", false, event => { });
                    break;
            }
        });
    }
    static gameLaunched(gameInfoResult) {
        if (!gameInfoResult) {
            return false;
        }
        if (!gameInfoResult.gameInfo) {
            return false;
        }
        if (!gameInfoResult.runningChanged && !gameInfoResult.gameChanged) {
            return false;
        }
        if (!gameInfoResult.gameInfo.isRunning) {
            return false;
        }
        if (Math.floor(gameInfoResult.gameInfo.id / 10) != 5426) {
            return false;
        }
        console.info("TFT Launched");
        return true;
    }
    static gameRunning(gameInfo) {
        if (!gameInfo) {
            return false;
        }
        if (!gameInfo.isRunning) {
            return false;
        }
        if (Math.floor(gameInfo.id / 10) != 5426) {
            return false;
        }
        console.info("TFT running");
        return true;
    }
    async setPosition() {
        const gameRes = await this.getGameResolution();
        if (gameRes === null) {
            return;
        }
        const appRes = await this.getAppResolution();
        overwolf.windows.changeSize("overlay", 350, 170);
        overwolf.windows.changePosition("overlay", gameRes.width - appRes.width, gameRes.height - appRes.height);
    }
    getGameResolution() {
        return new Promise(resolve => {
            overwolf.games.getRunningGameInfo((result) => {
                if (result && result.logicalWidth) {
                    resolve({
                        width: result.logicalWidth,
                        height: result.logicalHeight
                    });
                }
                else {
                    resolve(null);
                }
            });
        });
    }
    getAppResolution() {
        return new Promise(resolve => {
            overwolf.windows.getCurrentWindow((result) => {
                resolve({
                    width: result.window.width,
                    height: result.window.height
                });
            });
        });
    }
    getSummonerName() {
        return new Promise(resolve => {
            overwolf.games.launchers.events.getInfo(10902, info => {
                if (info.success) {
                    resolve(info.res.summoner_info.display_name);
                }
                else {
                    setTimeout(() => {
                        console.log("Failed to get summoner name, trying again in 2s");
                        resolve(this.getSummonerName());
                    }, 2000);
                }
            });
        });
    }
}
exports.Overlay = Overlay;
exports.overlay = new Overlay();
window.overlay = exports.overlay;


/***/ })

/******/ 	});
/************************************************************************/
/******/ 	
/******/ 	// startup
/******/ 	// Load entry module and return exports
/******/ 	// This entry module is referenced by other modules so it can't be inlined
/******/ 	var __webpack_exports__ = {};
/******/ 	__webpack_modules__["./src/overlay/overlay.ts"](0, __webpack_exports__);
/******/ 	
/******/ })()
;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly90ZnQtc2NvdXQvLi9zcmMvb3ZlcmxheS9vdmVybGF5LnRzIiwid2VicGFjazovL3RmdC1zY291dC93ZWJwYWNrL3N0YXJ0dXAiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQWdCQSxNQUFhLE9BQU87SUFpQmhCO1FBZlEsWUFBTyxHQUFhLEVBQUUsQ0FBQztRQUN2QixhQUFRLEdBQVcsRUFBRSxDQUFDO1FBQ3RCLFNBQUksR0FBVyx3REFBd0QsQ0FBQztRQUN4RSwyQkFBc0IsR0FBRztZQUM3QixVQUFVO1lBQ1YsWUFBWTtZQUNaLElBQUk7WUFDSixRQUFRO1lBQ1IsT0FBTztZQUNQLE9BQU87WUFDUCxPQUFPO1lBQ1AsVUFBVTtZQUNWLGtCQUFrQjtTQUNyQixDQUFDO1FBR0UsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO0lBR2pCLENBQUM7SUFFTyxLQUFLO1FBQ1QsUUFBUSxDQUFDLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxXQUFXLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRTtZQUNqRCxPQUFPLENBQUMsS0FBSyxDQUFDLG1CQUFtQixFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBQ3hDLElBQUksR0FBRyxDQUFDLFdBQVcsRUFBQztnQkFDaEIsSUFBSSxDQUFDLE9BQU8sR0FBRyxFQUFFLENBQUM7YUFDckI7WUFDRCxJQUFJLE9BQU8sQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLEVBQUU7Z0JBQzNCLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztnQkFDdEIsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsRUFBRSxJQUFJLENBQUMsQ0FBQzthQUM5QztRQUNMLENBQUMsQ0FBQyxDQUFDO1FBRUgsUUFBUSxDQUFDLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO1lBQ3RDLE9BQU8sQ0FBQyxLQUFLLENBQUMsb0JBQW9CLEVBQUUsR0FBRyxDQUFDLENBQUM7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LEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztBQUNyQyxNQUFNLENBQUMsT0FBTyxHQUFHLGVBQU8sQ0FBQzs7Ozs7Ozs7VUNuWHpCO1VBQ0E7VUFDQTtVQUNBO1VBQ0EiLCJmaWxlIjoianMvb3ZlcmxheS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9XR2FtZXNFdmVudHMgfSBmcm9tIFwiQG92ZXJ3b2xmL292ZXJ3b2xmLWFwaS10cy9kaXN0XCI7XG5cbmRlY2xhcmUgdmFyIHdpbmRvdzogYW55O1xuXG5pbnRlcmZhY2UgUGxheWVyIHtcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAgYm94OiBIVE1MRWxlbWVudDtcbn1cblxuaW50ZXJmYWNlIFBsYXllckRhdGF7XG4gICAgaW5kZXg6IG51bWJlcjtcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAgaGVhbHRoOiBudW1iZXI7XG4gICAgeHA6IG51bWJlcjtcbn1cblxuZXhwb3J0IGNsYXNzIE92ZXJsYXkge1xuXG4gICAgcHJpdmF0ZSBwbGF5ZXJzOiBQbGF5ZXJbXSA9IFtdO1xuICAgIHByaXZhdGUgc2VsZk5hbWU6IHN0cmluZyA9IFwiXCI7XG4gICAgcHJpdmF0ZSBwYXRoOiBzdHJpbmcgPSBcIkU6XFxcXERldmVsb3BtZW50XFxcXFB5dGhvblxcXFxURlQtT0NSLUJPVC1tYWluXFxcXGxpdmVfZGF0YVxcXFxcIjtcbiAgICBwcml2YXRlIGdfaW50ZXJlc3RlZEluRmVhdHVyZXMgPSBbXG4gICAgICAgICdjb3VudGVycycsXG4gICAgICAgICdtYXRjaF9pbmZvJyxcbiAgICAgICAgJ21lJyxcbiAgICAgICAgJ3Jvc3RlcicsXG4gICAgICAgICdzdG9yZScsXG4gICAgICAgICdib2FyZCcsXG4gICAgICAgICdiZW5jaCcsXG4gICAgICAgICdjYXJvdXNlbCcsXG4gICAgICAgICdsaXZlX2NsaWVudF9kYXRhJ1xuICAgIF07XG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgdGhpcy5zZXR1cCgpO1xuXG4gICAgICAgIC8vdGhpcy5zZXREZWJ1ZygpO1xuICAgIH1cblxuICAgIHByaXZhdGUgc2V0dXAoKXtcbiAgICAgICAgb3ZlcndvbGYuZ2FtZXMub25HYW1lSW5mb1VwZGF0ZWQuYWRkTGlzdGVuZXIoKHJlcykgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5kZWJ1ZyhcIm9uR2FtZUluZm9VcGRhdGVkXCIsIHJlcyk7XG4gICAgICAgICAgICBpZiAocmVzLmdhbWVDaGFuZ2VkKXtcbiAgICAgICAgICAgICAgICB0aGlzLnBsYXllcnMgPSBbXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChPdmVybGF5LmdhbWVMYXVuY2hlZChyZXMpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5yZWdpc3RlckV2ZW50cygpO1xuICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5zZXRGZWF0dXJlcygpLCAxMDAwKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgb3ZlcndvbGYuZ2FtZXMuZ2V0UnVubmluZ0dhbWVJbmZvKChyZXMpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoXCJnZXRSdW5uaW5nR2FtZUluZm9cIiwgcmVzKTtcbiAgICAgICAgICAgIGlmIChPdmVybGF5LmdhbWVSdW5uaW5nKHJlcykpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnJlZ2lzdGVyRXZlbnRzKCk7XG4gICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLnNldEZlYXR1cmVzKCksIDEwMDApO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLnBsYXllcnMgPSBbXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgb3ZlcndvbGYuZ2FtZXMubGF1bmNoZXJzLmV2ZW50cy5nZXRJbmZvKDEwOTAyLCBpbmZvID0+IHtcbiAgICAgICAgICAgIGlmIChpbmZvLnN1Y2Nlc3Mpe1xuICAgICAgICAgICAgICAgIHRoaXMuc2VsZk5hbWUgPSBpbmZvLnJlcy5zdW1tb25lcl9pbmZvLmRpc3BsYXlfbmFtZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5zZXRQb3NpdGlvbigpO1xuICAgIH1cblxuICAgIHByaXZhdGUgc2V0RmVhdHVyZXMoKSB7XG4gICAgICAgIG92ZXJ3b2xmLmdhbWVzLmV2ZW50cy5zZXRSZXF1aXJlZEZlYXR1cmVzKHRoaXMuZ19pbnRlcmVzdGVkSW5GZWF0dXJlcywgKGluZm86IGFueSkgPT4ge1xuICAgICAgICAgICAgaWYgKCFpbmZvLnN1Y2Nlc3MpIHtcbiAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmluZm8oXCJDb3VsZCBub3Qgc2V0IHJlcXVpcmVkIGZlYXR1cmVzOiBcIiArIGluZm8ucmVhc29uKTtcbiAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmluZm8oXCJUcnlpbmcgaW4gMiBzZWNvbmRzXCIpO1xuICAgICAgICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KCgpID0+IHRoaXMuc2V0RmVhdHVyZXMoKSwgMjAwMCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zb2xlLmluZm8oXCJTZXQgcmVxdWlyZWQgZmVhdHVyZXM6XCIpO1xuICAgICAgICAgICAgY29uc29sZS5pbmZvKEpTT04uc3RyaW5naWZ5KGluZm8pKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBoYW5kbGVFdmVudChpbmZvOiBhbnkpe1xuICAgICAgICBjb25zdCBmZWF0dXJlID0gaW5mby5mZWF0dXJlO1xuICAgICAgICBjb25zdCBrZXkgPSBpbmZvLmtleTtcblx0XHRcblx0XHQvLyBjb25zb2xlLmluZm8oSlNPTi5zdHJpbmdpZnkoaW5mbykpO1xuXG4gICAgICAgIGlmIChmZWF0dXJlID09PSBcInJvc3RlclwiICYmIGtleSA9PT0gXCJwbGF5ZXJfc3RhdHVzXCIpe1xuICAgICAgICAgICAgdGhpcy5oYW5kbGVSb3N0ZXIoaW5mby52YWx1ZSk7XG4gICAgICAgIH0gZWxzZSBpZiAoZmVhdHVyZSA9PT0gXCJtYXRjaF9pbmZvXCIgJiYga2V5ID09PSBcIm9wcG9uZW50XCIpe1xuICAgICAgICAgICAgdGhpcy5zZXRMYXN0T3Bwb25lbnQoaW5mby52YWx1ZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGhhbmRsZVJvc3Rlcihqc29uU3RyOiBzdHJpbmcpe1xuICAgICAgICBjb25zdCByb3N0ZXIgPSBKU09OLnBhcnNlKGpzb25TdHIpO1xuXG4gICAgICAgIGNvbnN0IHBsYXllcnM6IEFycmF5PFBsYXllckRhdGE+ID0gW107XG5cbiAgICAgICAgZm9yIChjb25zdCBuYW1lIGluIHJvc3Rlcil7XG4gICAgICAgICAgICBjb25zdCBwbGF5ZXJEYXRhOiBQbGF5ZXJEYXRhID0gcm9zdGVyW25hbWVdO1xuICAgICAgICAgICAgcGxheWVyRGF0YS5uYW1lID0gbmFtZTtcblxuICAgICAgICAgICAgcGxheWVycy5wdXNoKHBsYXllckRhdGEpO1xuICAgICAgICB9XG5cbiAgICAgICAgcGxheWVycy5zb3J0KChhLCBiKSA9PiBhLmluZGV4IC0gYi5pbmRleCk7XG5cbiAgICAgICAgaWYgKHBsYXllcnMubGVuZ3RoKXtcbiAgICAgICAgICAgIGlmICh0aGlzLnBsYXllcnMubGVuZ3RoICYmIHBsYXllcnMubGVuZ3RoKXtcbiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVJvc3RlcihwbGF5ZXJzKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXR1cFJvc3RlcihwbGF5ZXJzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgc2V0dXBSb3N0ZXIocGxheWVyczogUGxheWVyRGF0YVtdKXtcbiAgICAgICAgLy8gY29uc29sZS5pbmZvKFwiSW5pdGlhbGlzaW5nIHJvc3RlclwiLCBwbGF5ZXJzKTtcblxuICAgICAgICBpZiAoIXRoaXMuc2VsZk5hbWUpe1xuICAgICAgICAgICAgdGhpcy5zZWxmTmFtZSA9IGF3YWl0IHRoaXMuZ2V0U3VtbW9uZXJOYW1lKCk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIHRoaXMucmVzZXQoKTtcblxuICAgICAgICBwbGF5ZXJzLmZvckVhY2goKGRhdGEsIGkpID0+IHtcbiAgICAgICAgICAgIGlmIChkYXRhLm5hbWUgIT09IHRoaXMuc2VsZk5hbWUpe1xuICAgICAgICAgICAgICAgIGNvbnN0IGJveCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYCNib3gtJHtpfWApIGFzIEhUTUxFbGVtZW50O1xuICAgICAgICAgICAgICAgIGNvbnN0IHBsYXllcjogUGxheWVyID0geyBuYW1lOiBkYXRhLm5hbWUsIGJveDogYm94IH07XG4gICAgICAgICAgICAgICAgcGxheWVyLmJveC5zdHlsZS5ib3JkZXJDb2xvciA9IFwiZ3JlZW5cIjtcbiAgICAgICAgICAgICAgICB0aGlzLnBsYXllcnMucHVzaChwbGF5ZXIpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLnNldFBvc2l0aW9uKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB1cGRhdGVSb3N0ZXIocGxheWVyczogUGxheWVyRGF0YVtdKXtcbiAgICAgICAgLy8gY29uc29sZS5pbmZvKFwiVXBkYXRpbmcgcm9zdGVyXCIpO1xuXG4gICAgICAgIGNvbnN0IG1lID0gcGxheWVycy5maW5kKHBsYXllciA9PiBwbGF5ZXIubmFtZSA9PT0gdGhpcy5zZWxmTmFtZSk7XG4gICAgICAgIGlmIChtZSAmJiBtZS5oZWFsdGggPD0gMCl7XG4gICAgICAgICAgICB0aGlzLnJlc2V0KCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnBsYXllcnMuZm9yRWFjaChwbGF5ZXIgPT4ge1xuICAgICAgICAgICAgcGxheWVycy5mb3JFYWNoKGRhdGEgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChwbGF5ZXIubmFtZSA9PT0gZGF0YS5uYW1lICYmIGRhdGEuaGVhbHRoIDw9IDApe1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZVBsYXllcihkYXRhLm5hbWUudHJpbSgpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSByZW1vdmVQbGF5ZXIobmFtZTogc3RyaW5nKXtcbiAgICAgICAgLy8gY29uc29sZS5pbmZvKGBSZW1vdmluZzogJHtuYW1lfWApO1xuXG4gICAgICAgIGNvbnN0IHBsYXllciA9IHRoaXMucGxheWVycy5maW5kKHBsYXllciA9PiBwbGF5ZXIubmFtZS50cmltKCkgPT09IG5hbWUudHJpbSgpKTtcbiAgICAgICAgY29uc3QgaW5kZXggPSB0aGlzLnBsYXllcnMuaW5kZXhPZihwbGF5ZXIpO1xuXG4gICAgICAgIGlmIChpbmRleCAhPT0gLTEpe1xuICAgICAgICAgICAgdGhpcy5wbGF5ZXJzLnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgICAgICBwbGF5ZXIuYm94LnN0eWxlLmJvcmRlckNvbG9yID0gXCJ0cmFuc3BhcmVudFwiO1xuICAgICAgICAgICAgdGhpcy5jbGVhcigpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzZXRMYXN0T3Bwb25lbnQoanNvblN0cjogc3RyaW5nKXtcbiAgICAgICAgaWYgKHRoaXMucGxheWVycy5sZW5ndGggPT09IDApe1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qgb3Bwb25lbnROYW1lID0gSlNPTi5wYXJzZShqc29uU3RyKS5uYW1lLnRyaW0oKTtcbiAgICAgICAgY29uc3Qgb3Bwb25lbnQgPSB0aGlzLnBsYXllcnMuZmluZChwbGF5ZXIgPT4gcGxheWVyLm5hbWUgPT09IG9wcG9uZW50TmFtZSk7XG4gICAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5wbGF5ZXJzLmluZGV4T2Yob3Bwb25lbnQpO1xuXG4gICAgICAgIC8vIGNvbnNvbGUuaW5mbyhgTEFTVCBPUFBPTkVOVCBXQVMgJHtvcHBvbmVudE5hbWV9YCk7XG5cbiAgICAgICAgaWYgKGluZGV4ICE9PSAtMSl7XG4gICAgICAgICAgICB0aGlzLnBsYXllcnMuc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgICAgICAgIHRoaXMucGxheWVycy5wdXNoKG9wcG9uZW50KTtcbiAgICAgICAgICAgIG9wcG9uZW50LmJveC5zdHlsZS5ib3JkZXJDb2xvciA9IFwicmVkXCI7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnVwZGF0ZU92ZXJsYXkoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHVwZGF0ZU92ZXJsYXkoKXtcbiAgICAgICAgY29uc3QgcG90ZW50aWFsQ291bnQgPSB0aGlzLnBsYXllcnMubGVuZ3RoID4gMyA/IDMgOiB0aGlzLnBsYXllcnMubGVuZ3RoIC0gMTtcblxuICAgICAgICB0aGlzLnBsYXllcnMuc2xpY2UoMCwgcG90ZW50aWFsQ291bnQpLmZvckVhY2gocGxheWVyID0+IHtcbiAgICAgICAgICAgIHBsYXllci5ib3guc3R5bGUuYm9yZGVyQ29sb3IgPSBcImdyZWVuXCI7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgY2xlYXIoKXtcbiAgICAgICAgLy8gY29uc29sZS5pbmZvKGBBIHBsYXllciB3YXMgZWxpbWluYXRlZCwgY2xlYXJpbmdgKTtcblxuICAgICAgICB0aGlzLnBsYXllcnMuZm9yRWFjaChwbGF5ZXIgPT4ge1xuICAgICAgICAgICAgcGxheWVyLmJveC5zdHlsZS5ib3JkZXJDb2xvciA9IFwiZ3JlZW5cIjtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSByZXNldCgpe1xuICAgICAgICAvLyBjb25zb2xlLmluZm8oXCJSZXNldFwiKTtcblxuICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKGAuYm94YCkuZm9yRWFjaCgoYm94OiBhbnkpID0+IGJveC5zdHlsZS5ib3JkZXJDb2xvciA9IFwidHJhbnNwYXJlbnRcIik7XG5cbiAgICAgICAgdGhpcy5wbGF5ZXJzID0gW107XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzZXREZWJ1Zygpe1xuICAgICAgICBjb25zdCBkZWJ1Z0VsOiBIVE1MRWxlbWVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIuZGVidWdcIik7XG4gICAgICAgIGRlYnVnRWwuaW5uZXJIVE1MID0gYCR7dGhpcy5zZWxmTmFtZX08YnI+JHt0aGlzLnBsYXllcnMubWFwKHBsYXllciA9PiBwbGF5ZXIubmFtZSkuam9pbihcIjxicj5cIil9YDtcblxuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuc2V0RGVidWcoKSwgMTAwMCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSByZWdpc3RlckV2ZW50cygpIHtcbiAgICAgICAgY29uc29sZS5pbmZvKFwicmVnaXN0ZXIgZXZlbnRzXCIpO1xuXG4gICAgICAgIC8vIG92ZXJ3b2xmLmdhbWVzLmV2ZW50cy5vbkVycm9yLmFkZExpc3RlbmVyKChldmVudCkgPT4ge1xuICAgICAgICAvLyAgICAgLy8gY29uc29sZS5pbmZvKFwiRXJyb3I6IFwiICsgSlNPTi5zdHJpbmdpZnkoZXZlbnQpKTtcbiAgICAgICAgLy8gfSk7XG5cbiAgICAgICAgb3ZlcndvbGYuZ2FtZXMuZXZlbnRzLm9uSW5mb1VwZGF0ZXMuYWRkTGlzdGVuZXIoKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICAvLyB0aGlzLmhhbmRsZUV2ZW50KFwiSW5mbyBVUERBVEU6IFwiICsgSlNPTi5zdHJpbmdpZnkoZXZlbnQpKTtcbiAgICAgICAgICAgIHRoaXMuaGFuZGxlRXZlbnQoZXZlbnQuaW5mb1swXSk7XG5cblxuICAgICAgICB9KTtcblxuICAgICAgICBvdmVyd29sZi5nYW1lcy5ldmVudHMub25JbmZvVXBkYXRlczIuYWRkTGlzdGVuZXIoKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICAvLyB0aGlzLmhhbmRsZUV2ZW50KFwiSW5mbyBVUERBVEU6IFwiICsgSlNPTi5zdHJpbmdpZnkoZXZlbnQpKTtcblxuICAgICAgICAgICAgc3dpdGNoIChldmVudC5mZWF0dXJlKSB7XG4gICAgICAgICAgICAgICAgY2FzZSBcInN0b3JlXCI6XG4gICAgICAgICAgICAgICAgICAgIGlmKGV2ZW50LmluZm8pXG4gICAgICAgICAgICAgICAgICAgICAgICBvdmVyd29sZi5pby53cml0ZUZpbGVDb250ZW50cyh0aGlzLnBhdGggKyBcInN0b3JlLnR4dFwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIEpTT04uc3RyaW5naWZ5KGV2ZW50LmluZm8pLCBvdmVyd29sZi5pby5lbnVtcy5lRW5jb2RpbmcuVVRGOCwgZmFsc2UsIGV2ZW50ID0+IHsgfSk7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIGNhc2UgXCJib2FyZFwiOlxuICAgICAgICAgICAgICAgICAgICBpZihldmVudC5pbmZvKVxuICAgICAgICAgICAgICAgICAgICAgICAgb3ZlcndvbGYuaW8ud3JpdGVGaWxlQ29udGVudHModGhpcy5wYXRoICsgXCJib2FyZC50eHRcIixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBKU09OLnN0cmluZ2lmeShldmVudC5pbmZvKSwgb3ZlcndvbGYuaW8uZW51bXMuZUVuY29kaW5nLlVURjgsIGZhbHNlLCBldmVudCA9PiB7IH0pO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICBjYXNlIFwiYmVuY2hcIjpcbiAgICAgICAgICAgICAgICAgICAgaWYoZXZlbnQuaW5mbylcbiAgICAgICAgICAgICAgICAgICAgICAgIG92ZXJ3b2xmLmlvLndyaXRlRmlsZUNvbnRlbnRzKHRoaXMucGF0aCArIFwiYmVuY2gudHh0XCIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgSlNPTi5zdHJpbmdpZnkoZXZlbnQuaW5mbyksIG92ZXJ3b2xmLmlvLmVudW1zLmVFbmNvZGluZy5VVEY4LCBmYWxzZSwgZXZlbnQgPT4geyB9KTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG5cblxuICAgICAgICB9KTtcbiAgICAgICAgLy9cbiAgICAgICAgLy8gb3ZlcndvbGYuZ2FtZXMuZXZlbnRzLm9uTmV3RXZlbnRzLmFkZExpc3RlbmVyKChldmVudCkgPT4ge1xuICAgICAgICAvLyAgICAgLy8gdGhpcy5oYW5kbGVFdmVudChcIkVWRU5UIEZJUkVEOiBcIiArIEpTT04uc3RyaW5naWZ5KGV2ZW50KSk7XG4gICAgICAgIC8vXG4gICAgICAgIC8vXG4gICAgICAgIC8vIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgc3RhdGljIGdhbWVMYXVuY2hlZChnYW1lSW5mb1Jlc3VsdCkge1xuICAgICAgICBpZiAoIWdhbWVJbmZvUmVzdWx0KSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIWdhbWVJbmZvUmVzdWx0LmdhbWVJbmZvKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIWdhbWVJbmZvUmVzdWx0LnJ1bm5pbmdDaGFuZ2VkICYmICFnYW1lSW5mb1Jlc3VsdC5nYW1lQ2hhbmdlZCkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFnYW1lSW5mb1Jlc3VsdC5nYW1lSW5mby5pc1J1bm5pbmcpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIE5PVEU6IHdlIGRpdmlkZSBieSAxMCB0byBnZXQgdGhlIGdhbWUgY2xhc3MgaWQgd2l0aG91dCBpdCdzIHNlcXVlbmNlIG51bWJlclxuICAgICAgICBpZiAoTWF0aC5mbG9vcihnYW1lSW5mb1Jlc3VsdC5nYW1lSW5mby5pZCAvIDEwKSAhPSA1NDI2KSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zb2xlLmluZm8oXCJURlQgTGF1bmNoZWRcIik7XG4gICAgICAgIHJldHVybiB0cnVlO1xuXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgZ2FtZVJ1bm5pbmcoZ2FtZUluZm8pIHtcblxuICAgICAgICBpZiAoIWdhbWVJbmZvKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIWdhbWVJbmZvLmlzUnVubmluZykge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gTk9URTogd2UgZGl2aWRlIGJ5IDEwIHRvIGdldCB0aGUgZ2FtZSBjbGFzcyBpZCB3aXRob3V0IGl0J3Mgc2VxdWVuY2UgbnVtYmVyXG4gICAgICAgIGlmIChNYXRoLmZsb29yKGdhbWVJbmZvLmlkIC8gMTApICE9IDU0MjYpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnNvbGUuaW5mbyhcIlRGVCBydW5uaW5nXCIpO1xuICAgICAgICByZXR1cm4gdHJ1ZTtcblxuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgc2V0UG9zaXRpb24oKSB7XG4gICAgICAgIGNvbnN0IGdhbWVSZXMgPSBhd2FpdCB0aGlzLmdldEdhbWVSZXNvbHV0aW9uKCk7XG5cbiAgICAgICAgaWYgKGdhbWVSZXMgPT09IG51bGwpe1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgYXBwUmVzID0gYXdhaXQgdGhpcy5nZXRBcHBSZXNvbHV0aW9uKCk7XG5cbiAgICAgICAgb3ZlcndvbGYud2luZG93cy5jaGFuZ2VTaXplKFwib3ZlcmxheVwiLCAzNTAsIDE3MClcbiAgICAgICAgb3ZlcndvbGYud2luZG93cy5jaGFuZ2VQb3NpdGlvbihcIm92ZXJsYXlcIiwgZ2FtZVJlcy53aWR0aCAtIGFwcFJlcy53aWR0aCwgZ2FtZVJlcy5oZWlnaHQgLSBhcHBSZXMuaGVpZ2h0KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldEdhbWVSZXNvbHV0aW9uKCk6IFByb21pc2U8eyB3aWR0aDogbnVtYmVyLCBoZWlnaHQ6IG51bWJlciB9PiB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcbiAgICAgICAgICAgIG92ZXJ3b2xmLmdhbWVzLmdldFJ1bm5pbmdHYW1lSW5mbygocmVzdWx0KSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHJlc3VsdCAmJiByZXN1bHQubG9naWNhbFdpZHRoKXtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh7XG4gICAgICAgICAgICAgICAgICAgICAgICB3aWR0aDogcmVzdWx0LmxvZ2ljYWxXaWR0aCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGhlaWdodDogcmVzdWx0LmxvZ2ljYWxIZWlnaHRcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShudWxsKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRBcHBSZXNvbHV0aW9uKCk6IFByb21pc2U8eyB3aWR0aDogbnVtYmVyLCBoZWlnaHQ6IG51bWJlciB9PiB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcbiAgICAgICAgICAgIG92ZXJ3b2xmLndpbmRvd3MuZ2V0Q3VycmVudFdpbmRvdygocmVzdWx0KSA9PiB7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZSh7XG4gICAgICAgICAgICAgICAgICAgIHdpZHRoOiByZXN1bHQud2luZG93LndpZHRoLFxuICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IHJlc3VsdC53aW5kb3cuaGVpZ2h0XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRTdW1tb25lck5hbWUoKSA6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcbiAgICAgICAgICAgIG92ZXJ3b2xmLmdhbWVzLmxhdW5jaGVycy5ldmVudHMuZ2V0SW5mbygxMDkwMiwgaW5mbyA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGluZm8uc3VjY2Vzcyl7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoaW5mby5yZXMuc3VtbW9uZXJfaW5mby5kaXNwbGF5X25hbWUpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJGYWlsZWQgdG8gZ2V0IHN1bW1vbmVyIG5hbWUsIHRyeWluZyBhZ2FpbiBpbiAyc1wiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUodGhpcy5nZXRTdW1tb25lck5hbWUoKSk7XG4gICAgICAgICAgICAgICAgICAgIH0sIDIwMDApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG59XG5cbmV4cG9ydCBjb25zdCBvdmVybGF5ID0gbmV3IE92ZXJsYXkoKTtcbndpbmRvdy5vdmVybGF5ID0gb3ZlcmxheTsiLCIvLyBzdGFydHVwXG4vLyBMb2FkIGVudHJ5IG1vZHVsZSBhbmQgcmV0dXJuIGV4cG9ydHNcbi8vIFRoaXMgZW50cnkgbW9kdWxlIGlzIHJlZmVyZW5jZWQgYnkgb3RoZXIgbW9kdWxlcyBzbyBpdCBjYW4ndCBiZSBpbmxpbmVkXG52YXIgX193ZWJwYWNrX2V4cG9ydHNfXyA9IHt9O1xuX193ZWJwYWNrX21vZHVsZXNfX1tcIi4vc3JjL292ZXJsYXkvb3ZlcmxheS50c1wiXSgwLCBfX3dlYnBhY2tfZXhwb3J0c19fKTtcbiJdLCJzb3VyY2VSb290IjoiIn0=